{% extends "base.html" %}

{% block include_files %}
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map_canvas { height: 60% }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAAQDOZpCb33qnlU5xcBmf_n8CQ4p_qg6s&sensor=false">
    </script>
    <script type="text/javascript" src="http://www.google.com/jsapi"></script>
    <script type="text/javascript">
      google.load('visualization', '1', {packages: ['corechart']});
    </script>
<script type="text/javascript">
var map;
var infowindow = null;

function initialize() {
  var mapOptions = {
    center: new google.maps.LatLng(38.783360, -78.295143),
    zoom: 14,
    mapTypeId: google.maps.MapTypeId.TERRAIN
  };
  map = new google.maps.Map(document.getElementById("map_canvas"), mapOptions);
  show_locations()
}

function show_locations() {
{% if locations %}
var marker = [];
{% for loc in locations %}
  marker[{{ loop.index0  }}] = new google.maps.Marker({
    position: new google.maps.LatLng({{ loc.lat }}, {{ loc.lon }}),
    map: map,
    title:"{{ loc.name }}"
  });
  google.maps.event.addListener(marker[ {{ loop.index0 }} ], 'click', function() {
    if (infowindow != null){
      infowindow.close();
    }
    infowindow = new google.maps.InfoWindow({ content: "<h3>{{ loc.name }}</h3>{{ loc.lat }}, {{ loc.lon }}" });
    infowindow.open(map,marker[ {{ loop.index0 }} ]);
    show_details({{ loc.id }}, "{{ loc.name }}", {{loc.lat}}, {{loc.lon}})
    });
{% endfor %}
{% endif %}
}

function kelv_to_fahr(k){
  return ((k - 273.15) * 1.8) + 32.0;
}

function build_data_table(json){
  data = [];
  data[0] = ['Date', 'Temperature'];
  for(i=1;i<json.dates.length;i++){
    data[i] = [new Date(json.dates[i-1]), kelv_to_fahr(json.temps[i-1])];
  }
  return data;
}

function show_details(loc_id, loc_name, loc_lat, loc_lon){
  $("#loc_name").text(loc_name);
  $("#loc_coords").text(loc_lat + ", " + loc_lon);
  $.getJSON('http://localhost:5000/location/'+loc_id+'/temp', {}, function(json){
      show_data(build_data_table(json))
  });
  show_data();
}

function show_data(data_table){
  var temp_data = google.visualization.arrayToDataTable(data_table);
//      [['Date', 'Air Temperature'],
//      [new Date(2014, 1, 5), 30],
//      [new Date(2014, 1,6), 40]]);
  new google.visualization.LineChart(document.getElementById('chart')).
      draw(temp_data, {curveType: "function",
                  width: 800, height: 300,
                  vAxis: {maxValue: 10}}
          );
}


window.onload = initialize;
</script>
{% endblock %}

{% block title %}Ice Conditions{% endblock %}


{% block content %}

<div id="map_canvas" style="width:100%; height:60%"></div>

<div id="details">
  <div id="loc_name">

  </div>
  <div id="loc_coords">
  </div>
  <div id="debug_">
    Debug info
  </div>
</div>
<div id="chart" style="width:90%; height:40%"></div>
</div>


{% endblock %}
